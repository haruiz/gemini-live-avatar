import{TalkingHead as H}from"talkinghead";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const g of l.addedNodes)g.tagName==="LINK"&&g.rel==="modulepreload"&&n(g)}).observe(document,{childList:!0,subtree:!0});function e(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerPolicy&&(l.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?l.credentials="include":i.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function n(i){if(i.ep)return;i.ep=!0;const l=e(i);fetch(i.href,l)}})();class q{constructor(t){this.videoElement=t??null,this.currentStream=null,this.isWebcamActive=!1,this.isScreenActive=!1,this.frameCapture=null,this.frameCallback=null,this.usingFrontCamera=!0}async startWebcam(t=!0){try{const e=await navigator.mediaDevices.getUserMedia({video:{width:1280,height:720,facingMode:t?"user":"environment"}});return this.handleNewStream(e),this.isWebcamActive=!0,this.usingFrontCamera=t,this.dispatch("stream-start",{source:"webcam"}),!0}catch(e){return console.error("Error accessing webcam:",e),!1}}async startScreenShare(){try{const t=await navigator.mediaDevices.getDisplayMedia({video:!0});return this.handleNewStream(t),this.isScreenActive=!0,t.getVideoTracks()[0].addEventListener("ended",()=>{this.stopAll()}),this.dispatch("stream-start",{source:"screen"}),!0}catch(t){return console.error("Error sharing screen:",t),!1}}async switchCamera(){if(!this.isWebcamActive)return!1;const t=!this.usingFrontCamera;await this.stopAll();const e=await this.startWebcam(t);return e&&this.frameCallback&&this.startFrameCapture(this.frameCallback),e}handleNewStream(t){this.currentStream&&this.stopAll(),this.currentStream=t,this.videoElement&&(this.videoElement.srcObject=t,this.videoElement.classList.remove("hidden"))}stopAll(){this.currentStream&&(this.currentStream.getTracks().forEach(t=>t.stop()),this.currentStream=null),this.videoElement&&(this.videoElement.srcObject=null,this.videoElement.classList.add("hidden")),(this.isWebcamActive||this.isScreenActive)&&this.dispatch("stream-stop"),this.isWebcamActive=!1,this.isScreenActive=!1,this.stopFrameCapture()}startFrameCapture(t){this.frameCallback=t;const e=()=>{if(!this.currentStream||!this.videoElement)return;const n=document.createElement("canvas"),i=n.getContext("2d");n.width=this.videoElement.videoWidth,n.height=this.videoElement.videoHeight,i.drawImage(this.videoElement,0,0,n.width,n.height);const l=n.toDataURL("image/jpeg",.8).split(",")[1];this.frameCallback(l)};this.frameCapture=setInterval(e,1e3)}stopFrameCapture(){this.frameCapture&&(clearInterval(this.frameCapture),this.frameCapture=null)}dispatch(t,e={}){window.dispatchEvent(new CustomEvent(t,{detail:e}))}}class z{constructor(t,e={}){this.nodeAvatar=t,this.config=e,this.head=null,this.onLoading=(n,i)=>{console.log(`Avatar loading: ${n}`,i?`Progress: ${i.percent}%`:"")}}async load(){const{ttsApikey:t,lipsyncModules:e=["en"],cameraView:n="upper",lightAmbientIntensity:i=1,avatarPath:l="https://models.readyplayer.me/64bfa15f0e72c63d7c3934a6.glb?morphTargets=ARKit,Oculus+Visemes,mouthOpen,mouthSmile,eyesClosed,eyesLookUp,eyesLookDown&textureSizeLimit=1024&textureFormat=png",body:g="F",avatarMood:u="neutral",ttsLang:d,ttsVoice:a,lipsyncLang:c="en"}=this.config;this.onLoading("start");try{this.head=new H(this.nodeAvatar,{ttsEndpoint:"https://texttospeech.googleapis.com/v1beta1/text:synthesize",ttsApikey:t,lipsyncModules:e,cameraView:n,lightAmbientIntensity:i}),await this.head.showAvatar({url:l,body:g,avatarMood:u,ttsLang:d,ttsVoice:a,lipsyncLang:c},r=>{if(r.lengthComputable){const p=Math.min(100,Math.round(r.loaded/r.total*100));this.onLoading("progress",{percent:p})}}),this.onLoading("complete")}catch(r){console.error("❌ Failed to load avatar:",r),this.onLoading("error",{error:r})}}speak(t){var e,n;(n=(e=this.head)==null?void 0:e.speakText)==null||n.call(e,t)}playGesture(t,e=3){if(!this.head){console.error("❌ Avatar not loaded, cannot play gesture.");return}this.head.playGesture(t,e)}setLighting(t){if(!this.head){console.error("❌ Avatar not loaded, cannot set lighting.");return}this.head.setLighting(t)}}class J{constructor(t=null){if(!t)throw new Error("WebSocket endpoint is required.");this.endpoint=t,this.ws=null,this.isSpeaking=!1,this.shouldReconnect=!0,this.reconnectDelay=1e3,this.maxRetries=5,this.retryCount=0,this.reconnectTimeout=null,this.onReady=()=>{},this.onError=e=>console.error("WebSocket error:",e),this.onClose=()=>console.warn("WebSocket connection closed."),this.onMessage=e=>this._defaultMessageHandler(e),this.onMessageParsed=()=>{},this.onTurnComplete=()=>{},this.onFunctionCall=()=>{},this.onFunctionResponse=()=>{},this.onInterrupted=()=>{},this.onAudioData=()=>{},this.onTextContent=()=>{},this.connect()}connect(){console.log(`🌐 Connecting to ${this.endpoint}`),this.ws=new WebSocket(this.endpoint),this.ws.onopen=()=>{console.log("✅ WebSocket connected."),this.retryCount=0,this.reconnectDelay=1e3,this.onReady()},this.ws.onerror=t=>{console.error("❌ WebSocket error:",t),this.onError(t)},this.ws.onclose=t=>{console.warn("🔌 WebSocket closed:",t.reason||t.code),this.onClose(t),this.shouldReconnect&&this.retryCount<this.maxRetries?(this.retryCount++,this.reconnectTimeout=setTimeout(()=>{console.log(`🔁 Attempting to reconnect... (try ${this.retryCount})`),this.connect(),this.reconnectDelay*=2},this.reconnectDelay)):this.retryCount>=this.maxRetries&&console.error("🚫 Max reconnection attempts reached. Giving up.")},this.ws.onmessage=this.onMessage}_defaultMessageHandler(t){console.log("📬 Received message:",t.data);try{const e=JSON.parse(t.data);this.onMessageParsed(e),e.type==="interrupted"?(this.isSpeaking=!1,this.onInterrupted(e==null?void 0:e.data)):e.type==="audio"?this.onAudioData(e==null?void 0:e.data):e.type==="text"?this.onTextContent(e==null?void 0:e.data):e.type==="turn_complete"?this.onTurnComplete():e.type==="function_call"?this.onFunctionCall(e==null?void 0:e.data):e.type==="function_response"?this.onFunctionResponse(e==null?void 0:e.data):console.log("Received unknown message type:",e.type)}catch(e){console.error("❌ Parsing error:",e),this.onError({message:`Error parsing response: ${e.message}`,error_type:"client_error"})}}sendMessage(t){if(this.ws.readyState===WebSocket.OPEN)console.log(`🚀 Sending message [${t.type}]`),this.ws.send(JSON.stringify(t));else{const e=this.ws.readyState,n=["CONNECTING","OPEN","CLOSING","CLOSED"];this.onError(`WebSocket is not open (State: ${n[e]||"UNKNOWN"})`)}}async ensureConnected(){if(this.ws.readyState!==WebSocket.OPEN)return new Promise((t,e)=>{const n=setTimeout(()=>e(new Error("Timeout")),5e3),i=()=>{clearTimeout(n),g(),t()},l=u=>{clearTimeout(n),g(),e(u)},g=()=>{this.ws.removeEventListener("open",i),this.ws.removeEventListener("error",l)};this.ws.addEventListener("open",i),this.ws.addEventListener("error",l)})}disconnect(){this.shouldReconnect=!1,clearTimeout(this.reconnectTimeout),this.ws&&(console.log("🔌 Manually disconnecting..."),this.ws.close())}sendAudioChunk(t){this.sendMessage({type:"audio",data:t})}sendImage(t){this.sendMessage({type:"image",data:t})}sendTextMessage(t){this.sendMessage({type:"text",data:t})}sendEndMessage(){this.sendMessage({type:"end"})}}function K(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var R={exports:{}},$;function Q(){return $||($=1,function(s){var t=Object.prototype.hasOwnProperty,e="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(e=!1));function i(d,a,c){this.fn=d,this.context=a,this.once=c||!1}function l(d,a,c,r,p){if(typeof c!="function")throw new TypeError("The listener must be a function");var m=new i(c,r||d,p),h=e?e+a:a;return d._events[h]?d._events[h].fn?d._events[h]=[d._events[h],m]:d._events[h].push(m):(d._events[h]=m,d._eventsCount++),d}function g(d,a){--d._eventsCount===0?d._events=new n:delete d._events[a]}function u(){this._events=new n,this._eventsCount=0}u.prototype.eventNames=function(){var a=[],c,r;if(this._eventsCount===0)return a;for(r in c=this._events)t.call(c,r)&&a.push(e?r.slice(1):r);return Object.getOwnPropertySymbols?a.concat(Object.getOwnPropertySymbols(c)):a},u.prototype.listeners=function(a){var c=e?e+a:a,r=this._events[c];if(!r)return[];if(r.fn)return[r.fn];for(var p=0,m=r.length,h=new Array(m);p<m;p++)h[p]=r[p].fn;return h},u.prototype.listenerCount=function(a){var c=e?e+a:a,r=this._events[c];return r?r.fn?1:r.length:0},u.prototype.emit=function(a,c,r,p,m,h){var b=e?e+a:a;if(!this._events[b])return!1;var o=this._events[b],x=arguments.length,A,f;if(o.fn){switch(o.once&&this.removeListener(a,o.fn,void 0,!0),x){case 1:return o.fn.call(o.context),!0;case 2:return o.fn.call(o.context,c),!0;case 3:return o.fn.call(o.context,c,r),!0;case 4:return o.fn.call(o.context,c,r,p),!0;case 5:return o.fn.call(o.context,c,r,p,m),!0;case 6:return o.fn.call(o.context,c,r,p,m,h),!0}for(f=1,A=new Array(x-1);f<x;f++)A[f-1]=arguments[f];o.fn.apply(o.context,A)}else{var j=o.length,k;for(f=0;f<j;f++)switch(o[f].once&&this.removeListener(a,o[f].fn,void 0,!0),x){case 1:o[f].fn.call(o[f].context);break;case 2:o[f].fn.call(o[f].context,c);break;case 3:o[f].fn.call(o[f].context,c,r);break;case 4:o[f].fn.call(o[f].context,c,r,p);break;default:if(!A)for(k=1,A=new Array(x-1);k<x;k++)A[k-1]=arguments[k];o[f].fn.apply(o[f].context,A)}}return!0},u.prototype.on=function(a,c,r){return l(this,a,c,r,!1)},u.prototype.once=function(a,c,r){return l(this,a,c,r,!0)},u.prototype.removeListener=function(a,c,r,p){var m=e?e+a:a;if(!this._events[m])return this;if(!c)return g(this,m),this;var h=this._events[m];if(h.fn)h.fn===c&&(!p||h.once)&&(!r||h.context===r)&&g(this,m);else{for(var b=0,o=[],x=h.length;b<x;b++)(h[b].fn!==c||p&&!h[b].once||r&&h[b].context!==r)&&o.push(h[b]);o.length?this._events[m]=o.length===1?o[0]:o:g(this,m)}return this},u.prototype.removeAllListeners=function(a){var c;return a?(c=e?e+a:a,this._events[c]&&g(this,c)):(this._events=new n,this._eventsCount=0),this},u.prototype.off=u.prototype.removeListener,u.prototype.addListener=u.prototype.on,u.prefixed=e,u.EventEmitter=u,s.exports=u}(R)),R.exports}var X=Q();const Y=K(X),B=new Map;function Z(s,t){const e=new Blob([`${t}`],{type:"application/javascript"});return URL.createObjectURL(e)}const ee=`
class AudioProcessingWorklet extends AudioWorkletProcessor {
  // send and clear buffer every 2048 samples, 
  // which at 16khz is about 8 times a second
  buffer = new Int16Array(2048);

  // current write index
  bufferWriteIndex = 0;

  constructor() {
    super();
  }

  process(inputs) {
    if (inputs[0].length) {
      const channel0 = inputs[0][0];
      this.processChunk(channel0);
    }
    return true;
  }

  sendAndClearBuffer() {
    this.port.postMessage({
      event: "chunk",
      data: {
        int16arrayBuffer: this.buffer.slice(0, this.bufferWriteIndex).buffer,
      },
    });
    this.bufferWriteIndex = 0;
  }

  processChunk(float32Array) {
    const l = float32Array.length;
    
    for (let i = 0; i < l; i++) {
      // convert float32 -1 to 1 to int16 -32768 to 32767
      const int16Value = float32Array[i] * 32768;
      this.buffer[this.bufferWriteIndex++] = int16Value;
      if(this.bufferWriteIndex >= this.buffer.length) {
        this.sendAndClearBuffer();
      }
    }

    if(this.bufferWriteIndex >= this.buffer.length) {
      this.sendAndClearBuffer();
    }
  }
}

registerProcessor('audio-recorder-worklet', AudioProcessingWorklet);
`;function te(s){for(var t="",e=new Uint8Array(s),n=e.byteLength,i=0;i<n;i++)t+=String.fromCharCode(e[i]);return window.btoa(t)}async function se({sampleRate:s}){const t=new(window.AudioContext||window.webkitAudioContext)({sampleRate:s});return await t.resume(),t}class ne extends Y{constructor(){super(),this.sampleRate=16e3,this.stream=void 0,this.audioContext=void 0,this.source=void 0,this.recording=!1,this.recordingWorklet=void 0,this.starting=null,this.isMuted=!1}async start(){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Could not request user media");this.starting=new Promise(async(t,e)=>{this.stream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.audioContext=await se({sampleRate:this.sampleRate}),this.source=this.audioContext.createMediaStreamSource(this.stream);const n="audio-recorder-worklet",i=ee;B.has(this.audioContext)||B.set(this.audioContext,{});const l=B.get(this.audioContext);if(!l[n]){const g=Z(n,i);await this.audioContext.audioWorklet.addModule(g),l[n]={node:new AudioWorkletNode(this.audioContext,n),handlers:[]}}this.recordingWorklet=l[n].node,this.recordingWorklet.port.onmessage=async g=>{const u=g.data.data.int16arrayBuffer;if(u){const d=te(u);this.emit("data",d)}},this.source.connect(this.recordingWorklet),this.recording=!0,t(),this.starting=null})}stop(){const t=()=>{var e,n;(e=this.source)==null||e.disconnect(),(n=this.stream)==null||n.getTracks().forEach(i=>i.stop()),this.stream=void 0,this.recordingWorklet=void 0};if(this.starting){this.starting.then(t);return}t()}mute(){this.source&&this.recordingWorklet&&!this.isMuted&&(this.source.disconnect(this.recordingWorklet),this.isMuted=!0)}unmute(){this.source&&this.recordingWorklet&&this.isMuted&&(this.source.connect(this.recordingWorklet),this.isMuted=!1)}}const N=document.getElementById("text"),re=document.getElementById("btnSend"),U=document.getElementById("mic"),_=document.getElementById("camera"),I=document.getElementById("screenShare"),E=document.getElementById("videoPreview"),ie=document.getElementById("avatar"),S=document.getElementById("loading"),D=document.getElementById("outputBox");let y=null,M=!1,T=!1,P=!1;function W(s,t){s.classList.toggle("pulse-effect",t)}function v(s,t){const e=document.createElement("div"),n={user:{label:"user@console",color:"text-cyan-400",msgColor:"text-green-300"},gemini:{label:"gemini@core",color:"text-purple-400",msgColor:"text-green-300"},debug:{label:"[debug]",color:"text-yellow-400",msgColor:"text-yellow-200"}},{label:i,color:l,msgColor:g}=n[s]||{label:"system",color:"text-white",msgColor:"text-gray-300"};e.innerHTML=`<span class="${l}">${i}</span>: <span class="${g}">${t}</span>`,D.appendChild(e),D.scrollTop=D.scrollHeight}function G(s){const t=s.getBoundingClientRect();E.style.position="fixed",E.style.left=`${t.left+t.width/2-150}px`,E.style.top=`${t.top-300}px`,E.classList.remove("hidden"),E.classList.add("opacity-100")}const C=new q(E),w=new J("ws://localhost:8080/api/ws/live"),F=new ne,oe=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3});let L="";w.onReady=()=>v("debug","✅ Gemini API is ready.");w.onTextContent=s=>{s.trim()&&(L+=s)};w.onTurnComplete=()=>{v("debug","🔄 Turn complete."),L.trim()&&(y?(v("gemini",L),y.speak(L)):v("debug","⚠️ Avatar not loaded, skipping speech.")),L=""};w.onFunctionCall=s=>{var t;if(v("debug",`🔧 Function call: ${s.name} with args ${JSON.stringify(s.args)}`),s.name==="turn_on_the_lights"){y.playGesture("thumbup",3);const e=((t=s.args)==null?void 0:t.color)||16711680;y.setLighting({lightAmbientColor:e,lightAmbientIntensity:5,lightDirectColor:e,lightDirectIntensity:20})}else s.name==="turn_off_the_lights"&&(y.playGesture("thumbdown",3),y.setLighting({lightAmbientColor:16777215,lightAmbientIntensity:2,lightDirectColor:8947882,lightDirectIntensity:30,lightDirectPhi:.1,lightDirectTheta:2,lightSpotColor:3377407,lightSpotIntensity:0,lightSpotPhi:.1,lightSpotTheta:4,lightSpotDispersion:0}))};w.onMessageParsed=async s=>{if(s.type==="config"){y=new z(ie,{ttsEndpoint:"https://texttospeech.googleapis.com/v1beta1/text:synthesize",ttsApikey:s.ttsApikey,lipsyncModules:["en"],cameraView:"upper",lightAmbientIntensity:1,ttsLang:s.ttsLang,ttsVoice:s.ttsVoice,avatarPath:s.avatarPath}),y.onLoading=(t,e)=>{t==="start"?(S.textContent="Loading...",S.style.display="block"):t==="progress"?S.textContent=`Loading ${e.percent}%`:t==="complete"&&(S.style.display="none")};try{await y.load()}catch(t){console.error("❌ Avatar failed to load:",t),S.style.display="none",v("debug",`❌ Avatar loading error: ${t.message}`)}}};window.addEventListener("stream-start",s=>{v("debug",`📡 Stream started: ${s.detail.source}`)});window.addEventListener("stream-stop",()=>{v("debug","🛑 Stream stopped"),E.classList.add("hidden"),E.classList.remove("opacity-100"),T=!1,P=!1,W(_,!1),W(I,!1)});function V(){const s=N.value.trim();s&&(w.sendTextMessage(s),v("user",s),N.value="")}re.addEventListener("click",V);N.addEventListener("keydown",s=>{s.key==="Enter"&&(s.preventDefault(),V())});_.addEventListener("click",async()=>{C.isWebcamActive?(C.stopAll(),T=!1):await C.startWebcam(!0)&&(T=!0,G(_),C.startFrameCapture(e=>{w.sendImage(e)})),W(_,T)});I.addEventListener("click",async()=>{C.isScreenActive?(C.stopAll(),P=!1):await C.startScreenShare()&&(P=!0,G(I),C.startFrameCapture(e=>{w.sendImage(e)})),W(I,P)});document.addEventListener("visibilitychange",()=>{var t,e;const s=document.visibilityState==="visible";(e=(t=y==null?void 0:y.head)==null?void 0:t[s?"start":"stop"])==null||e.call(t),!s&&!M&&C.stopAll()});let ae=0,O=!1;async function ce(){try{await oe.resume(),await F.start(),O=!1,ae++,F.on("data",s=>{O||(v("debug","🎤 Recording started, sending audio chunks..."),O=!0),w.sendAudioChunk(s)}),M=!0}catch(s){console.error("Error starting recording:",s),v("debug",`❌ Error starting recording: ${s.message}`)}}function le(){F.stop(),M=!1,O=!1,v("debug","🎤 Recording stopped, audio sent to Gemini API."),w.sendEndMessage()}U.addEventListener("click",async()=>{M?le():await ce(),W(U,M)});
