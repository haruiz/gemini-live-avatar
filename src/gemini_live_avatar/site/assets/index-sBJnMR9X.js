import{TalkingHead as q}from"talkinghead";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const l of r)if(l.type==="childList")for(const p of l.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&n(p)}).observe(document,{childList:!0,subtree:!0});function e(r){const l={};return r.integrity&&(l.integrity=r.integrity),r.referrerPolicy&&(l.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?l.credentials="include":r.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function n(r){if(r.ep)return;r.ep=!0;const l=e(r);fetch(r.href,l)}})();class z{constructor(t){this.videoElement=t??null,this.currentStream=null,this.isWebcamActive=!1,this.isScreenActive=!1,this.frameCapture=null,this.frameCallback=null,this.usingFrontCamera=!0}async startWebcam(t=!0){try{const e=await navigator.mediaDevices.getUserMedia({video:{width:1280,height:720,facingMode:t?"user":"environment"}});return this.handleNewStream(e),this.isWebcamActive=!0,this.usingFrontCamera=t,this.dispatch("stream-start",{source:"webcam"}),!0}catch(e){return console.error("Error accessing webcam:",e),!1}}async startScreenShare(){try{const t=await navigator.mediaDevices.getDisplayMedia({video:!0});return this.handleNewStream(t),this.isScreenActive=!0,t.getVideoTracks()[0].addEventListener("ended",()=>{this.stopAll()}),this.dispatch("stream-start",{source:"screen"}),!0}catch(t){return console.error("Error sharing screen:",t),!1}}async switchCamera(){if(!this.isWebcamActive)return!1;const t=!this.usingFrontCamera;await this.stopAll();const e=await this.startWebcam(t);return e&&this.frameCallback&&this.startFrameCapture(this.frameCallback),e}handleNewStream(t){this.currentStream&&this.stopAll(),this.currentStream=t,this.videoElement&&(this.videoElement.srcObject=t,this.videoElement.classList.remove("hidden"))}stopAll(){this.currentStream&&(this.currentStream.getTracks().forEach(t=>t.stop()),this.currentStream=null),this.videoElement&&(this.videoElement.srcObject=null,this.videoElement.classList.add("hidden")),(this.isWebcamActive||this.isScreenActive)&&this.dispatch("stream-stop"),this.isWebcamActive=!1,this.isScreenActive=!1,this.stopFrameCapture()}startFrameCapture(t){this.frameCallback=t;const e=()=>{if(!this.currentStream||!this.videoElement)return;const n=document.createElement("canvas"),r=n.getContext("2d");n.width=this.videoElement.videoWidth,n.height=this.videoElement.videoHeight,r.drawImage(this.videoElement,0,0,n.width,n.height);const l=n.toDataURL("image/jpeg",.8).split(",")[1];this.frameCallback(l)};this.frameCapture=setInterval(e,1e3)}stopFrameCapture(){this.frameCapture&&(clearInterval(this.frameCapture),this.frameCapture=null)}dispatch(t,e={}){window.dispatchEvent(new CustomEvent(t,{detail:e}))}}function G(s){const t="models.readyplayer.me",e={morphTargets:"ARKit,Oculus+Visemes,mouthOpen,mouthSmile,eyesClosed,eyesLookUp,eyesLookDown",textureSizeLimit:"1024",textureFormat:"png"};try{const n=new URL(s);return n.hostname.includes(t)?(Object.entries(e).forEach(([r,l])=>{n.searchParams.has(r)||n.searchParams.set(r,l)}),n.toString()):(console.warn("❌ Not a valid Ready Player Me URL."),null)}catch(n){return console.error("⚠️ Invalid URL provided:",n.message),null}}const J="https://models.readyplayer.me/64bfa15f0e72c63d7c3934a6.glb?textureSizeLimit=2048",K=G(J);console.log(K);class Q{constructor(t,e={}){this.nodeAvatar=t,this.config=e,this.head=null,this.onLoading=(n,r)=>{console.log(`Avatar loading: ${n}`,r?`Progress: ${r.percent}%`:"")}}async load(){const{ttsApikey:t,lipsyncModules:e=["en"],cameraView:n="upper",lightAmbientIntensity:r=1,avatarPath:l="https://models.readyplayer.me/64bfa15f0e72c63d7c3934a6.glb",body:p="F",avatarMood:u="neutral",ttsLang:d,ttsVoice:a,lipsyncLang:c="en"}=this.config;this.onLoading("start");try{this.head=new q(this.nodeAvatar,{ttsEndpoint:"https://texttospeech.googleapis.com/v1beta1/text:synthesize",ttsApikey:t,lipsyncModules:e,cameraView:n,lightAmbientIntensity:r,modelFPS:60}),await this.head.showAvatar({url:G(l),body:p,avatarMood:u,ttsLang:d,ttsVoice:a,lipsyncLang:c},i=>{if(i.lengthComputable){const g=Math.min(100,Math.round(i.loaded/i.total*100));this.onLoading("progress",{percent:g})}}),this.onLoading("complete")}catch(i){console.error("❌ Failed to load avatar:",i),this.onLoading("error",{error:i})}}speak(t){var e,n;(n=(e=this.head)==null?void 0:e.speakText)==null||n.call(e,t)}playGesture(t,e=3){if(!this.head){console.error("❌ Avatar not loaded, cannot play gesture.");return}this.head.playGesture(t,e)}setLighting(t){if(!this.head){console.error("❌ Avatar not loaded, cannot set lighting.");return}this.head.setLighting(t)}}class X{constructor(t=null){if(!t)throw new Error("WebSocket endpoint is required.");this.endpoint=t,this.ws=null,this.isSpeaking=!1,this.shouldReconnect=!0,this.reconnectDelay=1e3,this.maxRetries=5,this.retryCount=0,this.reconnectTimeout=null,this.onReady=()=>{},this.onError=e=>console.error("WebSocket error:",e),this.onClose=()=>console.warn("WebSocket connection closed."),this.onMessage=e=>this._defaultMessageHandler(e),this.onMessageParsed=()=>{},this.onTurnComplete=()=>{},this.onFunctionCall=()=>{},this.onFunctionResponse=()=>{},this.onInterrupted=()=>{},this.onAudioData=()=>{},this.onTextContent=()=>{},this.connect()}connect(){console.log(`🌐 Connecting to ${this.endpoint}`),this.ws=new WebSocket(this.endpoint),this.ws.onopen=()=>{console.log("✅ WebSocket connected."),this.retryCount=0,this.reconnectDelay=1e3,this.onReady()},this.ws.onerror=t=>{console.error("❌ WebSocket error:",t),this.onError(t)},this.ws.onclose=t=>{console.warn("🔌 WebSocket closed:",t.reason||t.code),this.onClose(t),this.shouldReconnect&&this.retryCount<this.maxRetries?(this.retryCount++,this.reconnectTimeout=setTimeout(()=>{console.log(`🔁 Attempting to reconnect... (try ${this.retryCount})`),this.connect(),this.reconnectDelay*=2},this.reconnectDelay)):this.retryCount>=this.maxRetries&&console.error("🚫 Max reconnection attempts reached. Giving up.")},this.ws.onmessage=this.onMessage}_defaultMessageHandler(t){console.log("📬 Received message:",t.data);try{const e=JSON.parse(t.data);this.onMessageParsed(e),e.type==="interrupted"?(this.isSpeaking=!1,this.onInterrupted(e==null?void 0:e.data)):e.type==="audio"?this.onAudioData(e==null?void 0:e.data):e.type==="text"?this.onTextContent(e==null?void 0:e.data):e.type==="turn_complete"?this.onTurnComplete():e.type==="function_call"?this.onFunctionCall(e==null?void 0:e.data):e.type==="function_response"?this.onFunctionResponse(e==null?void 0:e.data):console.log("Received unknown message type:",e.type)}catch(e){console.error("❌ Parsing error:",e),this.onError({message:`Error parsing response: ${e.message}`,error_type:"client_error"})}}sendMessage(t){if(this.ws.readyState===WebSocket.OPEN)console.log(`🚀 Sending message [${t.type}]`),this.ws.send(JSON.stringify(t));else{const e=this.ws.readyState,n=["CONNECTING","OPEN","CLOSING","CLOSED"];this.onError(`WebSocket is not open (State: ${n[e]||"UNKNOWN"})`)}}async ensureConnected(){if(this.ws.readyState!==WebSocket.OPEN)return new Promise((t,e)=>{const n=setTimeout(()=>e(new Error("Timeout")),5e3),r=()=>{clearTimeout(n),p(),t()},l=u=>{clearTimeout(n),p(),e(u)},p=()=>{this.ws.removeEventListener("open",r),this.ws.removeEventListener("error",l)};this.ws.addEventListener("open",r),this.ws.addEventListener("error",l)})}disconnect(){this.shouldReconnect=!1,clearTimeout(this.reconnectTimeout),this.ws&&(console.log("🔌 Manually disconnecting..."),this.ws.close())}sendAudioChunk(t){this.sendMessage({type:"audio",data:t})}sendImage(t){this.sendMessage({type:"image",data:t})}sendTextMessage(t){this.sendMessage({type:"text",data:t})}sendEndMessage(){this.sendMessage({type:"end"})}}function Y(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var O={exports:{}},$;function Z(){return $||($=1,function(s){var t=Object.prototype.hasOwnProperty,e="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(e=!1));function r(d,a,c){this.fn=d,this.context=a,this.once=c||!1}function l(d,a,c,i,g){if(typeof c!="function")throw new TypeError("The listener must be a function");var m=new r(c,i||d,g),h=e?e+a:a;return d._events[h]?d._events[h].fn?d._events[h]=[d._events[h],m]:d._events[h].push(m):(d._events[h]=m,d._eventsCount++),d}function p(d,a){--d._eventsCount===0?d._events=new n:delete d._events[a]}function u(){this._events=new n,this._eventsCount=0}u.prototype.eventNames=function(){var a=[],c,i;if(this._eventsCount===0)return a;for(i in c=this._events)t.call(c,i)&&a.push(e?i.slice(1):i);return Object.getOwnPropertySymbols?a.concat(Object.getOwnPropertySymbols(c)):a},u.prototype.listeners=function(a){var c=e?e+a:a,i=this._events[c];if(!i)return[];if(i.fn)return[i.fn];for(var g=0,m=i.length,h=new Array(m);g<m;g++)h[g]=i[g].fn;return h},u.prototype.listenerCount=function(a){var c=e?e+a:a,i=this._events[c];return i?i.fn?1:i.length:0},u.prototype.emit=function(a,c,i,g,m,h){var b=e?e+a:a;if(!this._events[b])return!1;var o=this._events[b],x=arguments.length,A,f;if(o.fn){switch(o.once&&this.removeListener(a,o.fn,void 0,!0),x){case 1:return o.fn.call(o.context),!0;case 2:return o.fn.call(o.context,c),!0;case 3:return o.fn.call(o.context,c,i),!0;case 4:return o.fn.call(o.context,c,i,g),!0;case 5:return o.fn.call(o.context,c,i,g,m),!0;case 6:return o.fn.call(o.context,c,i,g,m,h),!0}for(f=1,A=new Array(x-1);f<x;f++)A[f-1]=arguments[f];o.fn.apply(o.context,A)}else{var H=o.length,S;for(f=0;f<H;f++)switch(o[f].once&&this.removeListener(a,o[f].fn,void 0,!0),x){case 1:o[f].fn.call(o[f].context);break;case 2:o[f].fn.call(o[f].context,c);break;case 3:o[f].fn.call(o[f].context,c,i);break;case 4:o[f].fn.call(o[f].context,c,i,g);break;default:if(!A)for(S=1,A=new Array(x-1);S<x;S++)A[S-1]=arguments[S];o[f].fn.apply(o[f].context,A)}}return!0},u.prototype.on=function(a,c,i){return l(this,a,c,i,!1)},u.prototype.once=function(a,c,i){return l(this,a,c,i,!0)},u.prototype.removeListener=function(a,c,i,g){var m=e?e+a:a;if(!this._events[m])return this;if(!c)return p(this,m),this;var h=this._events[m];if(h.fn)h.fn===c&&(!g||h.once)&&(!i||h.context===i)&&p(this,m);else{for(var b=0,o=[],x=h.length;b<x;b++)(h[b].fn!==c||g&&!h[b].once||i&&h[b].context!==i)&&o.push(h[b]);o.length?this._events[m]=o.length===1?o[0]:o:p(this,m)}return this},u.prototype.removeAllListeners=function(a){var c;return a?(c=e?e+a:a,this._events[c]&&p(this,c)):(this._events=new n,this._eventsCount=0),this},u.prototype.off=u.prototype.removeListener,u.prototype.addListener=u.prototype.on,u.prefixed=e,u.EventEmitter=u,s.exports=u}(O)),O.exports}var ee=Z();const te=Y(ee),B=new Map;function se(s,t){const e=new Blob([`${t}`],{type:"application/javascript"});return URL.createObjectURL(e)}const ne=`
class AudioProcessingWorklet extends AudioWorkletProcessor {
  // send and clear buffer every 2048 samples, 
  // which at 16khz is about 8 times a second
  buffer = new Int16Array(2048);

  // current write index
  bufferWriteIndex = 0;

  constructor() {
    super();
  }

  process(inputs) {
    if (inputs[0].length) {
      const channel0 = inputs[0][0];
      this.processChunk(channel0);
    }
    return true;
  }

  sendAndClearBuffer() {
    this.port.postMessage({
      event: "chunk",
      data: {
        int16arrayBuffer: this.buffer.slice(0, this.bufferWriteIndex).buffer,
      },
    });
    this.bufferWriteIndex = 0;
  }

  processChunk(float32Array) {
    const l = float32Array.length;
    
    for (let i = 0; i < l; i++) {
      // convert float32 -1 to 1 to int16 -32768 to 32767
      const int16Value = float32Array[i] * 32768;
      this.buffer[this.bufferWriteIndex++] = int16Value;
      if(this.bufferWriteIndex >= this.buffer.length) {
        this.sendAndClearBuffer();
      }
    }

    if(this.bufferWriteIndex >= this.buffer.length) {
      this.sendAndClearBuffer();
    }
  }
}

registerProcessor('audio-recorder-worklet', AudioProcessingWorklet);
`;function re(s){for(var t="",e=new Uint8Array(s),n=e.byteLength,r=0;r<n;r++)t+=String.fromCharCode(e[r]);return window.btoa(t)}async function ie({sampleRate:s}){const t=new(window.AudioContext||window.webkitAudioContext)({sampleRate:s});return await t.resume(),t}class oe extends te{constructor(){super(),this.sampleRate=16e3,this.stream=void 0,this.audioContext=void 0,this.source=void 0,this.recording=!1,this.recordingWorklet=void 0,this.starting=null,this.isMuted=!1}async start(){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Could not request user media");this.starting=new Promise(async(t,e)=>{this.stream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.audioContext=await ie({sampleRate:this.sampleRate}),this.source=this.audioContext.createMediaStreamSource(this.stream);const n="audio-recorder-worklet",r=ne;B.has(this.audioContext)||B.set(this.audioContext,{});const l=B.get(this.audioContext);if(!l[n]){const p=se(n,r);await this.audioContext.audioWorklet.addModule(p),l[n]={node:new AudioWorkletNode(this.audioContext,n),handlers:[]}}this.recordingWorklet=l[n].node,this.recordingWorklet.port.onmessage=async p=>{const u=p.data.data.int16arrayBuffer;if(u){const d=re(u);this.emit("data",d)}},this.source.connect(this.recordingWorklet),this.recording=!0,t(),this.starting=null})}stop(){const t=()=>{var e,n;(e=this.source)==null||e.disconnect(),(n=this.stream)==null||n.getTracks().forEach(r=>r.stop()),this.stream=void 0,this.recordingWorklet=void 0};if(this.starting){this.starting.then(t);return}t()}mute(){this.source&&this.recordingWorklet&&!this.isMuted&&(this.source.disconnect(this.recordingWorklet),this.isMuted=!0)}unmute(){this.source&&this.recordingWorklet&&this.isMuted&&(this.source.connect(this.recordingWorklet),this.isMuted=!1)}}const N=document.getElementById("text"),ae=document.getElementById("btnSend"),U=document.getElementById("mic"),W=document.getElementById("camera"),I=document.getElementById("screenShare"),E=document.getElementById("videoPreview"),ce=document.getElementById("avatar"),k=document.getElementById("loading"),D=document.getElementById("outputBox");let y=null,M=!1,P=!1,R=!1;function _(s,t){s.classList.toggle("pulse-effect",t)}function v(s,t){const e=document.createElement("div"),n={user:{label:"user@console",color:"text-cyan-400",msgColor:"text-green-300"},gemini:{label:"gemini@core",color:"text-purple-400",msgColor:"text-green-300"},debug:{label:"[debug]",color:"text-yellow-400",msgColor:"text-yellow-200"}},{label:r,color:l,msgColor:p}=n[s]||{label:"system",color:"text-white",msgColor:"text-gray-300"};e.innerHTML=`<span class="${l}">${r}</span>: <span class="${p}">${t}</span>`,D.appendChild(e),D.scrollTop=D.scrollHeight}function V(s){const t=s.getBoundingClientRect();E.style.position="fixed",E.style.left=`${t.left+t.width/2-150}px`,E.style.top=`${t.top-300}px`,E.classList.remove("hidden"),E.classList.add("opacity-100")}const C=new z(E),w=new X("ws://localhost:8080/api/ws/live"),F=new oe,le=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3});let L="";w.onReady=()=>v("debug","✅ Gemini API is ready.");w.onTextContent=s=>{s.trim()&&(L+=s)};w.onTurnComplete=()=>{v("debug","🔄 Turn complete."),L.trim()&&(y?(v("gemini",L),y.speak(L)):v("debug","⚠️ Avatar not loaded, skipping speech.")),L=""};w.onFunctionCall=s=>{var t;if(console.log(s),v("debug",`🔧 Function call: ${s.name} with args ${JSON.stringify(s.args)}, response: ${s.result}`),s.name==="turn_on_the_lights"){y.playGesture("thumbup",3);const e=((t=s.args)==null?void 0:t.color)||16711680;y.setLighting({lightAmbientColor:e,lightAmbientIntensity:5,lightDirectColor:e,lightDirectIntensity:20})}else s.name==="turn_off_the_lights"&&(y.playGesture("thumbdown",3),y.setLighting({lightAmbientColor:16777215,lightAmbientIntensity:2,lightDirectColor:8947882,lightDirectIntensity:30,lightDirectPhi:.1,lightDirectTheta:2,lightSpotColor:3377407,lightSpotIntensity:0,lightSpotPhi:.1,lightSpotTheta:4,lightSpotDispersion:0}))};w.onMessageParsed=async s=>{if(s.type==="config"){y=new Q(ce,{ttsEndpoint:"https://texttospeech.googleapis.com/v1beta1/text:synthesize",ttsApikey:s.ttsApikey,lipsyncModules:["en"],cameraView:"upper",lightAmbientIntensity:1,ttsLang:s.ttsLang,ttsVoice:s.ttsVoice,avatarPath:s.avatarPath}),y.onLoading=(t,e)=>{t==="start"?(k.textContent="Loading...",k.style.display="block"):t==="progress"?k.textContent=`Loading ${e.percent}%`:t==="complete"&&(k.style.display="none")};try{await y.load()}catch(t){console.error("❌ Avatar failed to load:",t),k.style.display="none",v("debug",`❌ Avatar loading error: ${t.message}`)}}};window.addEventListener("stream-start",s=>{v("debug",`📡 Stream started: ${s.detail.source}`)});window.addEventListener("stream-stop",()=>{v("debug","🛑 Stream stopped"),E.classList.add("hidden"),E.classList.remove("opacity-100"),P=!1,R=!1,_(W,!1),_(I,!1)});function j(){const s=N.value.trim();s&&(w.sendTextMessage(s),v("user",s),N.value="")}ae.addEventListener("click",j);N.addEventListener("keydown",s=>{s.key==="Enter"&&(s.preventDefault(),j())});W.addEventListener("click",async()=>{C.isWebcamActive?(C.stopAll(),P=!1):await C.startWebcam(!0)&&(P=!0,V(W),C.startFrameCapture(e=>{w.sendImage(e)})),_(W,P)});I.addEventListener("click",async()=>{C.isScreenActive?(C.stopAll(),R=!1):await C.startScreenShare()&&(R=!0,V(I),C.startFrameCapture(e=>{w.sendImage(e)})),_(I,R)});document.addEventListener("visibilitychange",()=>{var t,e;const s=document.visibilityState==="visible";(e=(t=y==null?void 0:y.head)==null?void 0:t[s?"start":"stop"])==null||e.call(t),!s&&!M&&C.stopAll()});let de=0,T=!1;async function ue(){try{await le.resume(),await F.start(),T=!1,de++,F.on("data",s=>{T||(v("debug","🎤 Recording started, sending audio chunks..."),T=!0),w.sendAudioChunk(s)}),M=!0}catch(s){console.error("Error starting recording:",s),v("debug",`❌ Error starting recording: ${s.message}`)}}function he(){F.stop(),M=!1,T=!1,v("debug","🎤 Recording stopped, audio sent to Gemini API."),w.sendEndMessage()}U.addEventListener("click",async()=>{M?he():await ue(),_(U,M)});
