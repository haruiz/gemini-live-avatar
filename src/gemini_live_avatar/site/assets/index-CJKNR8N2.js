import{TalkingHead as X}from"talkinghead";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const u of i.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&s(u)}).observe(document,{childList:!0,subtree:!0});function e(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(r){if(r.ep)return;r.ep=!0;const i=e(r);fetch(r.href,i)}})();class Y{constructor(t){this.videoElement=t??null,this.currentStream=null,this.isWebcamActive=!1,this.isScreenActive=!1,this.frameCapture=null,this.frameCallback=null,this.usingFrontCamera=!0}async startWebcam(t=!0){try{const e=await navigator.mediaDevices.getUserMedia({video:{width:1280,height:720,facingMode:t?"user":"environment"}});return this.handleNewStream(e),this.isWebcamActive=!0,this.usingFrontCamera=t,this.dispatch("stream-start",{source:"webcam"}),!0}catch(e){return console.error("Error accessing webcam:",e),!1}}async startScreenShare(){try{const t=await navigator.mediaDevices.getDisplayMedia({video:!0});return this.handleNewStream(t),this.isScreenActive=!0,t.getVideoTracks()[0].addEventListener("ended",()=>{this.stopAll()}),this.dispatch("stream-start",{source:"screen"}),!0}catch(t){return console.error("Error sharing screen:",t),!1}}async switchCamera(){if(!this.isWebcamActive)return!1;const t=!this.usingFrontCamera;await this.stopAll();const e=await this.startWebcam(t);return e&&this.frameCallback&&this.startFrameCapture(this.frameCallback),e}handleNewStream(t){this.currentStream&&this.stopAll(),this.currentStream=t,this.videoElement&&(this.videoElement.srcObject=t,this.videoElement.classList.remove("hidden"))}stopAll(){this.currentStream&&(this.currentStream.getTracks().forEach(t=>t.stop()),this.currentStream=null),this.videoElement&&(this.videoElement.srcObject=null,this.videoElement.classList.add("hidden")),(this.isWebcamActive||this.isScreenActive)&&this.dispatch("stream-stop"),this.isWebcamActive=!1,this.isScreenActive=!1,this.stopFrameCapture()}startFrameCapture(t){this.frameCallback=t;const e=()=>{if(!this.currentStream||!this.videoElement)return;const s=document.createElement("canvas"),r=s.getContext("2d");s.width=this.videoElement.videoWidth,s.height=this.videoElement.videoHeight,r.drawImage(this.videoElement,0,0,s.width,s.height);const i=s.toDataURL("image/jpeg",.8).split(",")[1];this.frameCallback(i)};this.frameCapture=setInterval(e,1e3)}stopFrameCapture(){this.frameCapture&&(clearInterval(this.frameCapture),this.frameCapture=null)}dispatch(t,e={}){window.dispatchEvent(new CustomEvent(t,{detail:e}))}}function Z(n){const t="models.readyplayer.me",e={morphTargets:"ARKit,Oculus+Visemes,mouthOpen,mouthSmile,eyesClosed,eyesLookUp,eyesLookDown",textureSizeLimit:"1024",textureFormat:"png"};try{const s=new URL(n);return s.hostname.includes(t)?(Object.entries(e).forEach(([r,i])=>{s.searchParams.has(r)||s.searchParams.set(r,i)}),s.toString()):(console.warn("❌ Not a valid Ready Player Me URL."),null)}catch(s){return console.error("⚠️ Invalid URL provided:",s.message),null}}class ee{constructor(t,e={}){this.nodeAvatar=t,this.config=e,this.head=null,this.isStreaming=!1,this.onTranscript=s=>{},this.onLoading=(s,r)=>{console.log(`Avatar loading: ${s}`,r?`Progress: ${r.percent}%`:"")}}async load(){const{ttsApikey:t,lipsyncModules:e=["en"],cameraView:s="upper",lightAmbientIntensity:r=1,avatarPath:i="https://models.readyplayer.me/64bfa15f0e72c63d7c3934a6.glb",body:u="F",avatarMood:h="neutral",ttsLang:d,ttsVoice:c,lipsyncLang:l="en"}=this.config;this.onLoading("start");try{this.head=new X(this.nodeAvatar,{ttsEndpoint:"https://texttospeech.googleapis.com/v1beta1/text:synthesize",ttsApikey:t,lipsyncModules:e,cameraView:s,lightAmbientIntensity:r,modelFPS:60}),await this.head.showAvatar({url:Z(i),body:u,avatarMood:h,ttsLang:d,ttsVoice:c,lipsyncLang:l},o=>{if(o.lengthComputable){const g=Math.min(100,Math.round(o.loaded/o.total*100));this.onLoading("progress",{percent:g})}}),this.onLoading("complete")}catch(o){console.error("❌ Failed to load avatar:",o),this.onLoading("error",{error:o})}}speakText(t){var e;(e=this.head)==null||e.speakText(t)}async speakAudio(t,e={}){try{console.log("🎤 Avatar speaking audio data:",t),this.isStreaming||(console.log("Starting audio stream..."),await this.head.streamStart({sampleRate:24e3,mood:"happy",lipsyncType:"words",gain:3},()=>{console.log("Audio playback started.")},()=>{console.log("Audio playback ended."),this.isStreaming=!1},s=>{console.log("subtitleText: ",s),s&&this.onTranscript(s)})),console.log(e),this.head.streamAudio({audio:t,words:e.words,wtimes:e.wtimes||[],wdurations:e.wdurations||[]})}catch(s){console.error("❌ Error speaking audio data:",s)}}playGesture(t,e=3){if(!this.head){console.error("❌ Avatar not loaded, cannot play gesture.");return}this.head.playGesture(t,e)}setLighting(t){if(!this.head){console.error("❌ Avatar not loaded, cannot set lighting.");return}this.head.setLighting(t)}}class te{constructor(t=null){if(!t)throw new Error("WebSocket endpoint is required.");this.endpoint=t,this.ws=null,this.isSpeaking=!1,this.shouldReconnect=!0,this.reconnectDelay=1e3,this.maxRetries=5,this.retryCount=0,this.reconnectTimeout=null,this.onReady=()=>{},this.onError=e=>console.error("WebSocket error:",e),this.onClose=()=>console.warn("WebSocket connection closed."),this.onMessage=e=>this._defaultMessageHandler(e),this.onMessageParsed=()=>{},this.onTurnComplete=()=>{},this.onFunctionCall=()=>{},this.onFunctionResponse=()=>{},this.onInterrupted=()=>{},this.onAudioData=()=>{},this.onTextContent=()=>{},this.connect()}connect(){console.log(`🌐 Connecting to ${this.endpoint}`),this.ws=new WebSocket(this.endpoint),this.ws.onopen=()=>{console.log("✅ WebSocket connected."),this.retryCount=0,this.reconnectDelay=1e3,this.onReady()},this.ws.onerror=t=>{console.error("❌ WebSocket error:",t),this.onError(t)},this.ws.onclose=t=>{console.warn("🔌 WebSocket closed:",t.reason||t.code),this.onClose(t),this.shouldReconnect&&this.retryCount<this.maxRetries?(this.retryCount++,this.reconnectTimeout=setTimeout(()=>{console.log(`🔁 Attempting to reconnect... (try ${this.retryCount})`),this.connect(),this.reconnectDelay*=2},this.reconnectDelay)):this.retryCount>=this.maxRetries&&console.error("🚫 Max reconnection attempts reached. Giving up.")},this.ws.onmessage=this.onMessage}_defaultMessageHandler(t){try{const e=JSON.parse(t.data);this.onMessageParsed(e),e.type==="interrupted"?(this.isSpeaking=!1,this.onInterrupted(e==null?void 0:e.data)):e.type==="audio"?this.onAudioData(e==null?void 0:e.data):e.type==="text"?this.onTextContent(e==null?void 0:e.data):e.type==="turn_complete"?this.onTurnComplete():e.type==="function_call"?this.onFunctionCall(e==null?void 0:e.data):e.type==="function_response"?this.onFunctionResponse(e==null?void 0:e.data):console.log("Received unknown message type:",e.type)}catch(e){console.error("❌ Parsing error:",e),this.onError({message:`Error parsing response: ${e.message}`,error_type:"client_error"})}}sendMessage(t){if(this.ws.readyState===WebSocket.OPEN)console.log(`🚀 Sending message [${t.type}]`),this.ws.send(JSON.stringify(t));else{const e=this.ws.readyState,s=["CONNECTING","OPEN","CLOSING","CLOSED"];this.onError(`WebSocket is not open (State: ${s[e]||"UNKNOWN"})`)}}async ensureConnected(){if(this.ws.readyState!==WebSocket.OPEN)return new Promise((t,e)=>{const s=setTimeout(()=>e(new Error("Timeout")),5e3),r=()=>{clearTimeout(s),u(),t()},i=h=>{clearTimeout(s),u(),e(h)},u=()=>{this.ws.removeEventListener("open",r),this.ws.removeEventListener("error",i)};this.ws.addEventListener("open",r),this.ws.addEventListener("error",i)})}disconnect(){this.shouldReconnect=!1,clearTimeout(this.reconnectTimeout),this.ws&&(console.log("🔌 Manually disconnecting..."),this.ws.close())}sendAudioChunk(t){this.sendMessage({type:"audio",data:t})}sendImage(t){this.sendMessage({type:"image",data:t})}sendTextMessage(t){this.sendMessage({type:"text",data:t})}sendEndMessage(){this.sendMessage({type:"end"})}}function se(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var $={exports:{}},H;function ne(){return H||(H=1,function(n){var t=Object.prototype.hasOwnProperty,e="~";function s(){}Object.create&&(s.prototype=Object.create(null),new s().__proto__||(e=!1));function r(d,c,l){this.fn=d,this.context=c,this.once=l||!1}function i(d,c,l,o,g){if(typeof l!="function")throw new TypeError("The listener must be a function");var m=new r(l,o||d,g),f=e?e+c:c;return d._events[f]?d._events[f].fn?d._events[f]=[d._events[f],m]:d._events[f].push(m):(d._events[f]=m,d._eventsCount++),d}function u(d,c){--d._eventsCount===0?d._events=new s:delete d._events[c]}function h(){this._events=new s,this._eventsCount=0}h.prototype.eventNames=function(){var c=[],l,o;if(this._eventsCount===0)return c;for(o in l=this._events)t.call(l,o)&&c.push(e?o.slice(1):o);return Object.getOwnPropertySymbols?c.concat(Object.getOwnPropertySymbols(l)):c},h.prototype.listeners=function(c){var l=e?e+c:c,o=this._events[l];if(!o)return[];if(o.fn)return[o.fn];for(var g=0,m=o.length,f=new Array(m);g<m;g++)f[g]=o[g].fn;return f},h.prototype.listenerCount=function(c){var l=e?e+c:c,o=this._events[l];return o?o.fn?1:o.length:0},h.prototype.emit=function(c,l,o,g,m,f){var b=e?e+c:c;if(!this._events[b])return!1;var a=this._events[b],C=arguments.length,S,p;if(a.fn){switch(a.once&&this.removeListener(c,a.fn,void 0,!0),C){case 1:return a.fn.call(a.context),!0;case 2:return a.fn.call(a.context,l),!0;case 3:return a.fn.call(a.context,l,o),!0;case 4:return a.fn.call(a.context,l,o,g),!0;case 5:return a.fn.call(a.context,l,o,g,m),!0;case 6:return a.fn.call(a.context,l,o,g,m,f),!0}for(p=1,S=new Array(C-1);p<C;p++)S[p-1]=arguments[p];a.fn.apply(a.context,S)}else{var K=a.length,E;for(p=0;p<K;p++)switch(a[p].once&&this.removeListener(c,a[p].fn,void 0,!0),C){case 1:a[p].fn.call(a[p].context);break;case 2:a[p].fn.call(a[p].context,l);break;case 3:a[p].fn.call(a[p].context,l,o);break;case 4:a[p].fn.call(a[p].context,l,o,g);break;default:if(!S)for(E=1,S=new Array(C-1);E<C;E++)S[E-1]=arguments[E];a[p].fn.apply(a[p].context,S)}}return!0},h.prototype.on=function(c,l,o){return i(this,c,l,o,!1)},h.prototype.once=function(c,l,o){return i(this,c,l,o,!0)},h.prototype.removeListener=function(c,l,o,g){var m=e?e+c:c;if(!this._events[m])return this;if(!l)return u(this,m),this;var f=this._events[m];if(f.fn)f.fn===l&&(!g||f.once)&&(!o||f.context===o)&&u(this,m);else{for(var b=0,a=[],C=f.length;b<C;b++)(f[b].fn!==l||g&&!f[b].once||o&&f[b].context!==o)&&a.push(f[b]);a.length?this._events[m]=a.length===1?a[0]:a:u(this,m)}return this},h.prototype.removeAllListeners=function(c){var l;return c?(l=e?e+c:c,this._events[l]&&u(this,l)):(this._events=new s,this._eventsCount=0),this},h.prototype.off=h.prototype.removeListener,h.prototype.addListener=h.prototype.on,h.prefixed=e,h.EventEmitter=h,n.exports=h}($)),$.exports}var re=ne();const ie=se(re),F=new Map;function oe(n,t){const e=new Blob([`${t}`],{type:"application/javascript"});return URL.createObjectURL(e)}const ae=`
class AudioProcessingWorklet extends AudioWorkletProcessor {
  // send and clear buffer every 2048 samples, 
  // which at 16khz is about 8 times a second
  buffer = new Int16Array(2048);

  // current write index
  bufferWriteIndex = 0;

  constructor() {
    super();
  }

  process(inputs) {
    if (inputs[0].length) {
      const channel0 = inputs[0][0];
      this.processChunk(channel0);
    }
    return true;
  }

  sendAndClearBuffer() {
    this.port.postMessage({
      event: "chunk",
      data: {
        int16arrayBuffer: this.buffer.slice(0, this.bufferWriteIndex).buffer,
      },
    });
    this.bufferWriteIndex = 0;
  }

  processChunk(float32Array) {
    const l = float32Array.length;
    
    for (let i = 0; i < l; i++) {
      // convert float32 -1 to 1 to int16 -32768 to 32767
      const int16Value = float32Array[i] * 32768;
      this.buffer[this.bufferWriteIndex++] = int16Value;
      if(this.bufferWriteIndex >= this.buffer.length) {
        this.sendAndClearBuffer();
      }
    }

    if(this.bufferWriteIndex >= this.buffer.length) {
      this.sendAndClearBuffer();
    }
  }
}

registerProcessor('audio-recorder-worklet', AudioProcessingWorklet);
`;function ce(n){for(var t="",e=new Uint8Array(n),s=e.byteLength,r=0;r<s;r++)t+=String.fromCharCode(e[r]);return window.btoa(t)}async function le({sampleRate:n}){const t=new(window.AudioContext||window.webkitAudioContext)({sampleRate:n});return await t.resume(),t}class ue extends ie{constructor(){super(),this.sampleRate=16e3,this.stream=void 0,this.audioContext=void 0,this.source=void 0,this.recording=!1,this.recordingWorklet=void 0,this.starting=null,this.isMuted=!1}async start(){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Could not request user media");this.starting=new Promise(async(t,e)=>{this.stream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.audioContext=await le({sampleRate:this.sampleRate}),this.source=this.audioContext.createMediaStreamSource(this.stream);const s="audio-recorder-worklet",r=ae;F.has(this.audioContext)||F.set(this.audioContext,{});const i=F.get(this.audioContext);if(!i[s]){const u=oe(s,r);await this.audioContext.audioWorklet.addModule(u),i[s]={node:new AudioWorkletNode(this.audioContext,s),handlers:[]}}this.recordingWorklet=i[s].node,this.recordingWorklet.port.onmessage=async u=>{const h=u.data.data.int16arrayBuffer;if(h){const d=ce(h);this.emit("data",d)}},this.source.connect(this.recordingWorklet),this.recording=!0,t(),this.starting=null})}stop(){const t=()=>{var e,s;(e=this.source)==null||e.disconnect(),(s=this.stream)==null||s.getTracks().forEach(r=>r.stop()),this.stream=void 0,this.recordingWorklet=void 0};if(this.starting){this.starting.then(t);return}t()}mute(){this.source&&this.recordingWorklet&&!this.isMuted&&(this.source.disconnect(this.recordingWorklet),this.isMuted=!0)}unmute(){this.source&&this.recordingWorklet&&this.isMuted&&(this.source.connect(this.recordingWorklet),this.isMuted=!1)}}class de{constructor(t,e=null){this.context=t,this.sampleRate=24e3,this.audioQueue=[],this.isPlaying=!1,this.currentSource=null,this.gainNode=this.context.createGain(),this.gainNode.connect(this.context.destination),this.addPCM16=this.addPCM16.bind(this),this.onComplete=()=>{},this.playbackTimeout=null,this.lastPlaybackTime=0,this.avatar=e}addPCM16(t){const e=new Float32Array(t.length/2),s=new DataView(t.buffer);for(let i=0;i<t.length/2;i++)try{const u=s.getInt16(i*2,!0);e[i]=u/32768}catch(u){console.error(u)}const r=this.context.createBuffer(1,e.length,this.sampleRate);r.getChannelData(0).set(e),this.audioQueue.push(r),this.isPlaying||(this.isPlaying=!0,this.lastPlaybackTime=this.context.currentTime,this.playNextBuffer()),this.checkPlaybackStatus()}checkPlaybackStatus(){this.playbackTimeout&&clearTimeout(this.playbackTimeout),this.playbackTimeout=setTimeout(()=>{this.context.currentTime-this.lastPlaybackTime>1&&this.audioQueue.length>0&&this.isPlaying&&(console.log("Playback appears to have stalled, restarting..."),this.playNextBuffer()),this.isPlaying&&this.checkPlaybackStatus()},1e3)}playNextBuffer(){if(this.audioQueue.length===0){this.isPlaying=!1;return}this.lastPlaybackTime=this.context.currentTime;try{const t=this.audioQueue.shift(),e=this.context.createBufferSource();if(e.buffer=t,e.connect(this.gainNode),this.currentSource)try{this.currentSource.disconnect()}catch{}this.currentSource=e,e.onended=()=>{this.lastPlaybackTime=this.context.currentTime,this.audioQueue.length>0?setTimeout(()=>this.playNextBuffer(),0):(this.isPlaying=!1,this.onComplete())},e.start(0)}catch(t){console.error("Error during playback:",t),this.audioQueue.length>0?setTimeout(()=>this.playNextBuffer(),100):this.isPlaying=!1}}stop(){if(this.isPlaying=!1,this.playbackTimeout&&(clearTimeout(this.playbackTimeout),this.playbackTimeout=null),this.currentSource)try{this.currentSource.stop(),this.currentSource.disconnect()}catch{}this.audioQueue=[],this.gainNode.gain.linearRampToValueAtTime(0,this.context.currentTime+.1),setTimeout(()=>{this.gainNode.disconnect(),this.gainNode=this.context.createGain(),this.gainNode.connect(this.context.destination)},200)}async resume(){this.context.state==="suspended"&&await this.context.resume(),this.lastPlaybackTime=this.context.currentTime,this.gainNode.gain.setValueAtTime(1,this.context.currentTime),this.audioQueue.length>0&&!this.isPlaying&&(this.isPlaying=!0,this.playNextBuffer())}complete(){this.audioQueue.length>0||(this.playbackTimeout&&(clearTimeout(this.playbackTimeout),this.playbackTimeout=null),this.onComplete())}}const V=document.getElementById("text"),he=document.getElementById("btnSend"),j=document.getElementById("mic"),I=document.getElementById("camera"),_=document.getElementById("screenShare"),k=document.getElementById("videoPreview"),fe=document.getElementById("avatar"),T=document.getElementById("loading"),U=document.getElementById("outputBox"),A=document.getElementById("liveTranscript");let v=null,P=!1,W=!1,B=!1;const x=new Y(k),w=new te("ws://localhost:8080/api/ws/live"),G=new ue,q=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3}),pe=new de(q);let L="",D=0,Q=-1,R=!1,N=-1,O=[];function M(n,t){n.classList.toggle("pulse-effect",t)}function y(n,t){const e=document.createElement("div"),s={user:{label:"user@console",color:"text-cyan-400",msgColor:"text-green-300"},gemini:{label:"gemini@core",color:"text-purple-400",msgColor:"text-green-300"},debug:{label:"system@debug",color:"text-yellow-400",msgColor:"text-yellow-200"},error:{label:"system@error",color:"text-red-400",msgColor:"text-red-300"}},{label:r,color:i,msgColor:u}=s[n]||{label:"unknown",color:"text-gray-400",msgColor:"text-gray-300"};e.innerHTML=`<span class="${i}">${r}</span>: <span class="${u}">${t}</span>`,U.appendChild(e),U.scrollTop=U.scrollHeight}function z(n){const t=n.getBoundingClientRect();k.style.position="fixed",k.style.left=`${t.left+t.width/2-150}px`,k.style.top=`${t.top-300}px`,k.classList.remove("hidden"),k.classList.add("opacity-100")}w.onReady=()=>y("debug","✅ Gemini API is ready.");w.onTextContent=n=>{n.trim()&&(L+=n)};function ge(n){const t=atob(n),e=new Uint8Array(t.length);for(let s=0;s<t.length;s++)e[s]=t.charCodeAt(s);return e.buffer}w.onTurnComplete=()=>{y("debug","🔄 Turn complete."),L.trim()&&(v?(y("gemini",L),v.speakText(L)):y("debug","⚠️ Avatar not loaded, skipping speech.")),w.isSpeaking=!1,L="",Q=D,pe.complete(),A.innerHTML="",O=[],N=-1,A.classList.add("hidden")};w.onAudioData=async n=>{try{let t=n.audio,e=n.words;if((!w.isSpeaking||Q!==D)&&(y("debug","🔊 Playing audio data..."),w.isSpeaking=!0,Q=D),typeof t!="string"){console.error("Expected base64-encoded audio string, got:",typeof t);return}const s=ge(t),r=new Int16Array(s),i=new Float32Array(r.length);for(let u=0;u<r.length;u++)i[u]=r[u]/32768;await v.speakAudio(r,e)}catch(t){console.error("Error playing audio:",t)}};w.onFunctionCall=n=>{var t;if(y("debug",`🔧 Function call: ${n.name} with args ${JSON.stringify(n.args)}, response: ${n.result}`),n.name==="turn_on_the_lights"){v.playGesture("thumbup",3);const e=((t=n.args)==null?void 0:t.color)||16711680;v.setLighting({lightAmbientColor:e,lightAmbientIntensity:5,lightDirectColor:e,lightDirectIntensity:20})}else n.name==="turn_off_the_lights"&&(v.playGesture("thumbdown",3),v.setLighting({lightAmbientColor:16777215,lightAmbientIntensity:2,lightDirectColor:8947882,lightDirectIntensity:30,lightDirectPhi:.1,lightDirectTheta:2,lightSpotColor:3377407,lightSpotIntensity:0,lightSpotPhi:.1,lightSpotTheta:4,lightSpotDispersion:0}))};w.onMessageParsed=async n=>{var t,e;if(n.type==="config"){v=new ee(fe,{ttsEndpoint:"https://texttospeech.googleapis.com/v1beta1/text:synthesize",ttsApikey:n.ttsApikey,lipsyncModules:["en"],cameraView:"upper",lightAmbientIntensity:1,ttsLang:n.ttsLang,ttsVoice:n.ttsVoice,avatarPath:n.avatarPath}),v.onTranscript=s=>{if(s.trim()){A.classList.contains("hidden")&&A.classList.remove("hidden");const r=`word-${O.length}`,i=document.createElement("span");if(i.className="word",i.id=r,i.textContent=s,A.appendChild(i),A.scrollTop=A.scrollHeight,N>=0){const u=document.getElementById(`word-${N}`);u&&u.classList.remove("active")}i.classList.add("active"),N=O.length,O.push(s)}},v.onLoading=(s,r)=>{s==="start"?(T.textContent="Loading...",T.style.display="block"):s==="progress"?T.textContent=`Loading ${r.percent}%`:s==="complete"&&(T.style.display="none")};try{await v.load()}catch(s){console.error("❌ Avatar failed to load:",s),T.style.display="none",y("debug",`❌ Avatar loading error: ${s.message}`)}}else n.type==="error"?y("error",`❌ Error from Server: ${(t=n.data)==null?void 0:t.message}`):n.type==="debug"&&y("debug",`ℹ️ Info from Server: ${(e=n.data)==null?void 0:e.message}`)};window.addEventListener("stream-start",n=>{y("debug",`📡 Stream started: ${n.detail.source}`)});window.addEventListener("stream-stop",()=>{y("debug","🛑 Stream stopped"),k.classList.add("hidden"),k.classList.remove("opacity-100"),W=!1,B=!1,M(I,!1),M(_,!1)});function J(){const n=V.value.trim();n&&(w.sendTextMessage(n),y("user",n),V.value="")}he.addEventListener("click",J);V.addEventListener("keydown",n=>{n.key==="Enter"&&(n.preventDefault(),J())});I.addEventListener("click",async()=>{x.isWebcamActive?(x.stopAll(),W=!1):await x.startWebcam(!0)&&(W=!0,z(I),x.startFrameCapture(e=>{w.sendImage(e)})),M(I,W)});_.addEventListener("click",async()=>{x.isScreenActive?(x.stopAll(),B=!1):await x.startScreenShare()&&(B=!0,z(_),x.startFrameCapture(e=>{w.sendImage(e)})),M(_,B)});document.addEventListener("visibilitychange",()=>{var t,e;const n=document.visibilityState==="visible";(e=(t=v==null?void 0:v.head)==null?void 0:t[n?"start":"stop"])==null||e.call(t),!n&&!P&&x.stopAll()});async function me(){try{await q.resume(),await G.start(),R=!1,D++,G.on("data",n=>{R||(y("debug","🎤 Recording started, sending audio chunks..."),R=!0),w.sendAudioChunk(n)}),P=!0}catch(n){console.error("Error starting recording:",n),y("debug",`❌ Error starting recording: ${n.message}`)}}function ye(){G.stop(),P=!1,R=!1,y("debug","🎤 Recording stopped, audio sent to Gemini API."),w.sendEndMessage()}j.addEventListener("click",async()=>{P?ye():await me(),M(j,P)});
